# DIYBMS All-in-one 16S monitoring board

This is the code for the (up to) 16S monitoring board.

It uses an [STM32F030K6T6](https://www.st.com/en/microcontrollers-microprocessors/stm32f030k6.html) chip, with 32K flash and 4K RAM.

**WARNING**: This code is considered experimental & prototype, use at your own risk - it may not work as intended or at all.

## How to compile the code

### Pre-compiled
The easiest way to use the code is with the pre-compiled version generated by [GITHUB Actions](https://github.com/stuartpittaway/diyBMSv4ESP32/actions).

For this prototype version, look for successful compiles (green ticks) for the "all-in-one" branch.

Inside the action, you will see "Artifacts" - download the ZIP files for the pre-compiled version of the code, look inside the ZIP file for a "BIN" folder and the files named "module_fw_V490_10K_genericSTM32F030K6T6.bin" or similar.

### Manual compile
The code is written in C/C++ and you can use VSCode and Platform.IO to compile to code.

This can also be used to upload the code into the microcontroller.

Platform.IO should automatically configure the build environment and compile the code for you. 

Recommend installing GITHUB Desktop for a pain free experience.

The compiled code will be named "module_fw_V490_10K_genericSTM32F030K6T6.bin" inside the ".pio\build\V490_10K" folder - this uses the 10,000 baud communication speed.  A 5,000 baud (5K) version is also available.

## Programming the STM32 chip

Interfaces for both serial and ST-LINK are provided.  If you don't have an ST-LINK programmer, use the serial method below.

You will require [STM32 Cube Programmer](https://www.st.com/en/development-tools/stm32cubeprog.html) software.


### Serial Programming

Use an off the shelf [USB Serial adapter](https://amzn.to/44umP3v) (Silicon Labs CP210x or similar).

1. Disconnect the battery cells completely from the monitor PCB (2 pin and 17 pin terminal blocks on left of board).
2. Remove the "PWR" jump pin (if fitted)
3. Move the jump pin "PRG/RUN" to "PRG" (left 2 pins)
4. Connect the serial adapter to the connector marked "UART PROG".  Pins are marked on the silkscreen.
```
Serial Adapter -->  Monitoring PCB
     GND    -->    GND
     TX     -->    RX
     RX     -->    TX
     +3.3V  -->    3.3V
```
**Under no circumstances connect a 5V supply.  Ensure battery connector is unplugged.**

5. Using STM Cube Programmer, select "UART" (top right of screen) and click "CONNECT"
6. Using the "Erasing & Programming" option (2nd icon down, on left of screen)
7. Select the firmware file in "file path"
8. Check "Verify programming" and then "Start Programming"
9. Wait for "File Download Complete" message, click OK.
10. Wait for "Download verified successfully" message, click OK.
11. Move "PRG/RUN" jumper to "RUN"
12. Disconnect USB programming cable BEFORE connecting battery connector!
13. Once disconnected, re-connect "PWR" jumper if required.


### ST-LINK

Repeat above, but using ST-LINK connector on the PCB.  There is no need to change the "PRG/RUN" jumper setting.

Observe warnings about disconnecting the battery connector before programming, or connecting to your computer.

Use the STM32 Cube software to program the firmware using ST-LINK protocol.

## Error LED flash sequences

On power up (after successful programming of the STM32 chip with code) the LED may flash a light sequence in the event of an error.

* 0 = Successful power on
* 1 = Not used
* 2 = MAX14921 thermal shutdown
* 3 = Less than 4 cells detected (check wiring and soldering to MAX chip)
* 4 = MAX14921 VA pin (Analog Supply Voltage) below UV_VAVTH (4.7V)
* 5 = MAX14921 VP is below UV_VPVTH (6V)
* 6 = MAX14921 device reports not ready (after 5 seconds waiting)
* 7 = Unable to communicate with MAX14921 over SPI pins/interface

Most of these reasons are caused by poor soldering to the MAX14921 chip.  Check for solder bridges and loose pins (not soldered).

